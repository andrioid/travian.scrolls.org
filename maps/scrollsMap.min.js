Object.size=function(c){var b=0,a;for(a in c){if(c.hasOwnProperty(a)){b++}}return b};(function(a){a.fn.scrollsMap=function(f,k,j,i){var d=this;var h=Array();d.tz=2;d.state=0;d.defaults={};d.defaults.server="s3.travian.dk";d.defaults.zoomlevel=30;d.settings={};d.settings.dataTiles=80;d.settings.dataServer="http://travian.scrolls.org/maps/data";d.settings.tiles={};d.settings.tiles.village="images/fort.png";d.settings.tiles.city="images/city.png";d.tiles={};d.dataset={};if(i){var g=d.settings.zoomlevel=i}else{var g=d.settings.zoomlevel=d.defaults.zoomlevel}if(k){var e=k}else{var e=0}if(j){var c=j}else{var c=0}if(f){d.settings.server=f}else{d.settings.server=d.defaults.server}var b=0;var l=0;d.createCanvas=function(){d.html("<canvas></canvas>");d.append('<div id="controls"><div id="buttons"><a id="zoomin" href="#">Zoom In</a> <a id="zoomout" href="#">Zoom Out</a><a id="moveup" href="#">Up</a> <a id="movedown" href="#">Down</a> <a id="moveleft" href="#">Left</a> <a id="moveright" href="#">Right</a></div></div>');d.append('<div id="goto"><label>x</label> <input type=text id="inp_x"> <label>y</label> <input type=text id="inp_y"> <input id="submit" type="submit" value="Go"></div>');d.append('<div id="status"></div>');d.append('<div id="hoverbox"></div>');d.append('<div id="infobox"></div>');d.append('<div id="statusbox"><span class="text"></span><span class="icon"></span></div>');d.append('<div id="mask"></div>');d.canvas=a("canvas",d);if(d.canvas[0]){if(typeof(G_vmlCanvasManager)!="undefined"){G_vmlCanvasManager.initElement(d.canvas[0])}d.ctx=d.canvas[0].getContext("2d")}else{d.state=-1;d.trigger("mapclick")}};d.updateCanvas=function(){d.canvas.attr("width",d.x);d.canvas.attr("height",d.y);d.canvas.css("width",d.x);d.canvas.css("height",d.y);d.state=3;d.trigger("maptick")};d.loadTiles=function(){var m=Object.size(d.settings.tiles);var n=0;a.each(d.settings.tiles,function(o,p){d.tiles[o]=new Image();d.tiles[o].src=p;d.tiles[o].onload=function(){n++;if(n==m){d.state=1;d.trigger("maptick")}}})};d.loadData=function(){var s={};var r="";var n=0;var m=0;var p;for(var q=d.range.dsx;q<=d.range.dex;q++){for(var o=d.range.dsy;o<=d.range.dey;o++){p=q+","+o;if(d.dataset[p]){}else{m++;s[p]=d.settings.dataServer+"/"+d.settings.server+"/"+q+"_"+o+".json"}}}if(m==0){d.state=4;d.trigger("maptick")}a.each(s,function(t,u){a.get(u,function(v){a.each(v,function(w,x){d.addTown(v[w])});n++;d.dataset[t]=1;if(n==m){d.state=4;d.trigger("maptick")}},"json")})};d.render=function(){d.ctx.clearRect(0,0,d.x,d.y);d.renderGrid();a("#status",d).html("("+e+","+c+") Zoom: "+g);a("#inp_x",d).attr("value",e);a("#inp_y",d).attr("value",c);if(d.towns){a.each(d.towns,function(m,n){if(d.towns[m]){a.each(n,function(o,p){if(d.towns[m][o]&&p.x>d.range.sx&&p.x<d.range.ex&&p.y>d.range.sy&&p.y<d.range.ey){d.renderTown2(p)}})}})}d.state=5;d.trigger("maptick")};d.addTown=function(o){if(!o){console.log("d is not defined, wtf")}var n=Number(o.x);var m=Number(o.y);if(!d.towns){d.towns={}}if(!d.towns[n]){d.towns[n]={}}d.towns[n][m]=o};d.inScopePoint=function(m,n){if(m<d.range.sx&&m>d.range.ex){return 0}if(n<d.range.sy&&n>d.range.ey){return 0}return 1};d.point2row=function(o){var n=Number(d.cx+o[0]-e);var m=Number(c+d.cy-o[1]);return([n,m])};d.row2point=function(o){var n=o[0]+(e-d.cx);var m=c-o[1]+d.cy;return([n,m])};d.pixel2row=function(o){var m=Math.floor((o[0]-d.xmargin)/d.tilesize);var n=Math.floor((o[1]-d.ymargin)/d.tilesize);return([m,n])};d.point2pixel=function(m){var p=d.point2row(m);if(p[0]<0||p[1]<0){}var o=Math.round((p[0]*d.tilesize)+d.xmargin);var n=Math.round((p[1]*d.tilesize)+d.ymargin);return([o,n])};d.pixel2point=function(m){return d.row2point(d.pixel2row(m))};d.renderGrid=function(){d.ctx.globalAlpha=0.025;for(var n=d.ymargin;n<=d.y-d.ymargin;n=n+d.tilesize){d.ctx.strokeStyle="rgb(0,0,0)";d.ctx.beginPath();d.ctx.moveTo(d.xmargin,n);d.ctx.lineTo(d.x-d.xmargin,n);d.ctx.closePath();d.ctx.stroke()}for(var o=d.xmargin;o<=d.x-d.xmargin;o=o+d.tilesize){d.ctx.strokeStyle="rgb(0,0,0)";d.ctx.beginPath();d.ctx.moveTo(o,d.ymargin);d.ctx.lineTo(o,d.y-d.ymargin);d.ctx.closePath();d.ctx.stroke()}d.ctx.globalAlpha=1;d.ctx.strokeStyle="#000000";var m=d.point2pixel([0,0]);d.ctx.strokeRect(m[0],m[1],d.tilesize,d.tilesize)};d.renderTown=function(m,s){m=Number(m);s=Number(s);if(m<d.range.sx||m>d.range.ex||s<d.range.sy||s>d.range.ey){console.log("broke rendertown");return}var p=d.point2pixel([m,s]);if(p==null){console.log(m+","+s)}var r=p[0];var o=p[1];if(d.tilesize>=32){d.ctx.fillStyle="rgb(20,0,0)";d.ctx.font=8+"px Helvetica";d.ctx.fillText(m+","+s,r+(d.tilesize/20),o+d.tilesize-(d.tilesize/20));var q=Math.round((d.tilesize/d.tiles.village.width)*d.tiles.village.width)-15;var n=Math.round((d.tilesize/d.tiles.village.height)*d.tiles.village.height)-15;d.ctx.drawImage(d.tiles.village,r+7.5,o+7.5,q,n)}else{if(d.tilesize<5){d.ctx.fillStyle="rgb(240,34,19)";d.ctx.fillRect(r,o,d.tilesize,d.tilesize)}else{d.ctx.strokeStyle="rgb(139,105,20)";d.ctx.fillStyle="rgb(173,216,230)";d.ctx.beginPath();d.ctx.arc(r+(d.tilesize/2),o+(d.tilesize/2),d.tilesize/2.5,0,Math.PI*2,true);d.ctx.stroke();d.ctx.fill();d.ctx.closePath();d.ctx.beginPath();d.ctx.strokeStyle="rgb(0,0,0)";d.ctx.fillStyle="rgb(240,34,19)";d.ctx.arc(r+(d.tilesize/2),o+(d.tilesize/2),d.tilesize/3.5,100,Math.PI*2,true);d.ctx.stroke();d.ctx.fill();d.ctx.closePath()}}return true};d.renderTown2=function(s){if(s.x<d.range.sx||s.x>d.range.ex||s.y<d.range.sy||s.y>d.range.ey){return}var o=d.point2pixel([Number(s.x),Number(s.y)]);var r=o[0];var n=o[1];var t=colorToString(randomColor(s.aid));if(d.tilesize>25){d.ctx.fillStyle="rgb(20,0,0)";d.ctx.font=8+"px Helvetica";d.ctx.fillText(s.x+","+s.y,r+(d.tilesize/20),n+d.tilesize-(d.tilesize/20));if(s.population>500){var q=Math.round((d.tilesize/d.tiles.city.width)*d.tiles.city.width)-15;var m=Math.round((d.tilesize/d.tiles.city.height)*d.tiles.city.height)-15;d.ctx.drawImage(d.tiles.city,r+7.5,n+7.5,q,m)}else{var q=Math.round((d.tilesize/d.tiles.village.width)*d.tiles.village.width)-15;var m=Math.round((d.tilesize/d.tiles.village.height)*d.tiles.village.height)-15;d.ctx.drawImage(d.tiles.village,r+7.5,n+7.5,q,m)}d.ctx.fillStyle=t;d.ctx.strokeStyle="#000000";d.ctx.beginPath();d.ctx.moveTo(r+d.tilesize-(d.tilesize/3),n+d.tilesize-(d.tilesize/10));d.ctx.lineTo(r+d.tilesize-(d.tilesize/3),n+(d.tilesize/2));d.ctx.lineTo(r+d.tilesize-(d.tilesize/10),n+d.tilesize-(d.tilesize/2));d.ctx.lineTo(r+d.tilesize-(d.tilesize/10),n+d.tilesize-(d.tilesize/3.5));d.ctx.lineTo(r+d.tilesize-(d.tilesize/3),n+d.tilesize-(d.tilesize/3.5));d.ctx.stroke();d.ctx.fill();var p=d.ctx.createLinearGradient(r+d.tilesize-(d.tilesize/3),n+d.tilesize-(d.tilesize/2),r+d.tilesize-(d.tilesize/10),n+d.tilesize-(d.tilesize/2));p.addColorStop(0,"#FFFFFF");p.addColorStop(0.5,"#000000");p.addColorStop(1,"#FFFFFF");d.ctx.fillStyle=p;d.ctx.globalAlpha=0.25;d.ctx.fill();d.ctx.globalAlpha=1;d.ctx.closePath()}else{d.ctx.fillStyle=t;d.ctx.beginPath();d.ctx.arc(r+(d.tilesize/2),n+(d.tilesize/2),d.tilesize/2,0,Math.PI*2,true);d.ctx.stroke();d.ctx.fill();d.ctx.closePath()}};d.updateVariables=function(){d.tilesize=d.tz*g;d.x=this.width();d.y=this.height();d.xtiles=Math.floor(d.x/d.tilesize);d.ytiles=Math.floor(d.y/d.tilesize);d.cx=Math.floor(d.xtiles/2);d.cy=Math.floor(d.ytiles/2);d.xmargin=(d.x-(d.xtiles*d.tilesize))/2;d.ymargin=(d.y-(d.ytiles*d.tilesize))/2;d.range={sx:e-(d.xtiles/2),ex:e+(d.xtiles/2),sy:c-(d.ytiles/2),ey:c+(d.ytiles/2)};d.range.dsx=Math.floor(d.range.sx/d.settings.dataTiles);d.range.dex=Math.floor(d.range.ex/d.settings.dataTiles);d.range.dsy=Math.floor(d.range.sy/d.settings.dataTiles);d.range.dey=Math.floor(d.range.ey/d.settings.dataTiles);d.state=2;d.trigger("maptick")};d.zoomIn=function(){g=g*2;d.state=1;d.trigger("maptick")};d.zoomOut=function(){g=g/2;if(g<1){g=1;d.state=1;d.trigger("maptick");return false}d.state=1;d.trigger("maptick")};d.moveUp=function(){c=c+Math.floor(d.ytiles/4);d.state=1;d.trigger("maptick")};d.moveDown=function(){c=c-Math.floor(d.ytiles/4);d.state=1;d.trigger("maptick")};d.moveRight=function(){e=e+Math.floor(d.xtiles/4);d.state=1;d.trigger("maptick")};d.moveLeft=function(){e=e-Math.floor(d.xtiles/4);d.state=1;d.trigger("maptick")};d.pixelToPoint=function(m,r){m=m-d.xmargin;r=r-d.ymargin;m=Math.min(m,d.xtiles*d.tilesize);r=Math.min(r,d.ytiles*d.tilesize);var o=Math.floor(m/d.tilesize);var q=Math.floor(r/d.tilesize);var n=e+o-d.cx;var p=c-q+d.cy;return([n,p])};d.pointToPixel=function(m,r){var o=Number(m)+Number(e)-Number(0);var n=c+d.cy-r;var q=((o*d.tilesize)+d.xmargin);var p=((n*d.tilesize)+d.ymargin);if(q<0||p<0){console.log("Points: "+o+","+n+" Pixels:"+q+","+p);return null}return([q,p])};d.debugPoint=function(m){var o=d.point2pixel(m);d.ctx.fillStyle="rgb(0,0,0)";d.ctx.font="10px Helvetica";var p=d.pixel2row([o[0],o[1]]);d.ctx.fillText("row:"+p[0]+","+p[1],o[0],o[1]-20);d.ctx.fillText("pixels:"+o[0]+","+o[1],o[0],o[1]-10);var n=d.row2point([p[0],p[1]]);d.ctx.fillText("points:"+n[0]+","+n[1],o[0],o[1]);d.ctx.fillText("spoints:"+m[0]+","+m[1],o[0],o[1]+10)};d.createCanvas();d.statusbox=a("#statusbox",d);d.statusbox.text=function(m,n){this.css("top",d.height()/2-this.height()/2);this.css("left",d.width()/2-this.width()/2);a(".text",this).html(m);if(!n){a(".icon",this).addClass("wait")}else{a(".icon",this).addClass("error")}};d.bind("maptick",function(n){var m="state:"+d.state;if(d.state<5){d.statusbox.fadeIn(100)}else{d.statusbox.fadeOut(50)}switch(d.state){case -1:d.statusbox.text("<p>Your browser does not support HTML5 Canvas.</p> <p>Please consider using Google Chrome or Firefox.</p>","error");break;case 0:d.statusbox.text("Preloading map graphics...");d.loadTiles();break;case 1:d.updateVariables();break;case 2:d.updateCanvas();break;case 3:d.statusbox.text("Loading remote map data...");d.loadData();break;case 4:d.statusbox.text("Rendering...");d.render();break;case 5:break;default:alert("Unsupported map state");break}});d.canvas.mousewheel(function(o,p,n,m){if(p<0){d.zoomOut()}else{d.zoomIn()}});d.canvas.dblclick(function(p){var o=p.pageX-d.canvas[0].offsetLeft;var n=p.pageY-d.canvas[0].offsetTop;var m=d.pixel2point([o,n]);e=m[0];c=m[1];g=d.defaults.zoomlevel;d.state=1;d.trigger("maptick")});d.infobox=function(n,q){var o=d.width();var p=d.height();var m=a("#infobox",d);m.html("("+n+","+q+")<br>");if(d.towns[n]&&d.towns[n][q]){m.append("<label>Player</label>:"+d.towns[n][q].player+"<br>");m.append("<label>Alliance</label>:"+d.towns[n][q].alliance+"<br>");m.append("<label>Population</label>:"+d.towns[n][q].population+"<br>")}m.append("<label>Tile Range</label>: ("+d.range.dsx+","+d.range.dsy+") - ("+d.range.dex+","+d.range.dey+")<br>");m.append("tilesize:"+d.tilesize+"<br>");m.css("top",d.height()/2-m.height()-d.tilesize);m.css("left",d.width()/2-m.width()/2);m.css("position","absolute");m.fadeIn(100)};d.canvas.mousemove(function(r){b=r.pageX-d.canvas[0].offsetLeft;l=r.pageY-d.canvas[0].offsetTop;var m=d.pixel2point([b,l]);var o=m[0];var n=m[1];var p=a("#hoverbox",d);if(d.towns&&d.towns[o]&&d.towns[o][n]){var q=d.towns[o][n];p.show();d.canvas.css("cursor","hand");p.css("left",b-p.width()/2);p.css("top",l+20);p.css("position","absolute");if(q.alliance!=null){p.html('<span id="player">'+q.player+"["+q.alliance+"]</span><br>")}else{p.html('<span id="player">'+q.player+"</span><br>")}p.append('<span id="village">'+q.village+" ("+q.population+")</span><br>");p.append('<span id="xy">('+q.x+","+q.y+")</span><br>")}else{d.canvas.css("cursor","auto");p.hide()}});d.bind("resize",function(){d.state=1;d.trigger("maptick")});a("a#zoomin",d).click(function(m){m.preventDefault();d.zoomIn()});a("a#zoomout",d).click(function(m){m.preventDefault();d.zoomOut()});a("a#movedown",d).click(function(m){m.preventDefault();d.moveDown()});a("a#moveup",d).click(function(m){m.preventDefault();d.moveUp()});a("a#moveleft",d).click(function(m){m.preventDefault();d.moveLeft()});a("a#moveright",d).click(function(m){m.preventDefault();d.moveRight()});a("#submit",d).click(function(m){m.preventDefault();e=Number(a("#inp_x").attr("value"));c=Number(a("#inp_y").attr("value"));g=d.settings.zoomlevel;d.state=1;d.trigger("maptick")});d.trigger("maptick")}})(jQuery);
